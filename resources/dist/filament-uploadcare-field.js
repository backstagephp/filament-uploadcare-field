var m=class{constructor(t){this.wrapper=t,this.observer=null,this.init()}init(){this.hideDoneButtons(),this.setupObserver()}setupObserver(){this.observer=new MutationObserver(t=>{t.forEach(e=>{e.type==="childList"&&e.addedNodes.forEach(i=>{if(i.nodeType===Node.ELEMENT_NODE){i.classList&&i.classList.contains("uc-done-btn")&&this.hideDoneButton(i);let a=i.querySelectorAll&&i.querySelectorAll(".uc-done-btn");a&&a.forEach(s=>this.hideDoneButton(s))}})})}),this.wrapper&&this.observer.observe(this.wrapper,{childList:!0,subtree:!0})}hideDoneButtons(){document.querySelectorAll(".uc-done-btn").forEach(e=>this.hideDoneButton(e))}hideDoneButton(t){t&&(t.style.display="none",t.style.visibility="hidden",t.style.opacity="0",t.style.pointerEvents="none",t.style.position="absolute",t.style.width="0",t.style.height="0",t.style.overflow="hidden",t.style.clip="rect(0, 0, 0, 0)",t.style.margin="0",t.style.padding="0",t.style.border="0",t.style.background="transparent",t.style.color="transparent",t.style.fontSize="0",t.style.lineHeight="0")}destroy(){this.observer&&(this.observer.disconnect(),this.observer=null)}};function g(u){return window._initializedUploadcareContexts||(window._initializedUploadcareContexts=new Set),{name:u.statePath||"unknown",state:u.state,statePath:u.statePath,initialState:u.initialState,publicKey:u.publicKey,isMultiple:u.isMultiple,multipleMin:u.multipleMin,multipleMax:u.multipleMax,isImagesOnly:u.isImagesOnly,accept:u.accept,sourceList:u.sourceList,uploaderStyle:u.uploaderStyle,isWithMetadata:u.isWithMetadata,localeName:u.localeName||"en",uploadedFiles:"",ctx:null,removeEventListeners:null,uniqueContextName:u.uniqueContextName,pendingUploads:[],pendingRemovals:[],isInitialized:!1,stateHasBeenInitialized:!1,isStateWatcherActive:!1,isLocalUpdate:!1,doneButtonHider:null,documentClassObserver:null,formInputObserver:null,isUpdatingState:!1,async init(){this.isContextAlreadyInitialized()||(this.markContextAsInitialized(),this.applyTheme(),await this.loadAllLocales(),this.$el.isConnected&&(this.setupStateWatcher(),this.$el.addEventListener("uploadcare-state-updated",t=>{let e=t.detail.uuid;e&&this.isInitialized?this.loadFileFromUuid(e):e&&this.$nextTick(()=>{this.isInitialized&&this.loadFileFromUuid(e)})}),this.initUploadcare(),this.setupThemeObservers(),this.setupDoneButtonObserver(),(!this.state||this.state==="[]"||this.state==='""')&&this.$nextTick(()=>{this.isInitialized&&this.getCurrentFiles().length>0&&this.clearAllFiles(!1)})))},isContextAlreadyInitialized(){return window._initializedUploadcareContexts.has(this.uniqueContextName)},markContextAsInitialized(){window._initializedUploadcareContexts.add(this.uniqueContextName)},async loadAllLocales(){window._uploadcareAllLocalesLoaded||await new Promise(e=>{if(window._uploadcareAllLocalesLoaded){e();return}let i=setInterval(()=>{window._uploadcareAllLocalesLoaded&&(clearInterval(i),e())},100);setTimeout(()=>{clearInterval(i),e()},5e3)});let t=["de","es","fr","he","it","nl","pl","pt","ru","tr","uk","zh-TW","zh"];document.querySelectorAll("uc-config[data-locale-name]").forEach(e=>{let i=e.getAttribute("data-locale-name");i&&t.includes(i)&&!e.getAttribute("locale-name")&&e.setAttribute("locale-name",i)})},async loadLocale(){if(this.localeName==="en"||this.localeLoaded)return;if(window._uploadcareLocales&&window._uploadcareLocales.has(this.localeName)){this.localeLoaded=!0;return}if(window._uploadcareLocales||(window._uploadcareLocales=new Set),!!["de","es","fr","he","it","nl","pl","pt","ru","tr","uk","zh-TW","zh"].includes(this.localeName))try{let i=await import(`https://cdn.jsdelivr.net/npm/@uploadcare/file-uploader@v1/locales/file-uploader/${this.localeName}.js`),a=i.default||i,s=()=>{let r=customElements.get("uc-file-uploader-inline")||customElements.get("uc-file-uploader-regular")||customElements.get("uc-file-uploader-minimal");return r&&r.UC?r.UC:window.UC},n=()=>{let r=s();return r&&typeof r.defineLocale=="function"?(r.defineLocale(this.localeName,a),window._uploadcareLocales.add(this.localeName),this.localeLoaded=!0,!0):!1};if(!n()){let r=0,o=50,c=setInterval(()=>{r++,(n()||r>=o)&&clearInterval(c)},100)}}catch(e){console.error("[Uploadcare Locale JS] Failed to load locale:",this.localeName,e)}},applyTheme(){let t=this.getCurrentTheme();this.$el.querySelectorAll(`uc-file-uploader-${this.uploaderStyle}`).forEach(i=>{i.classList.remove("uc-dark","uc-light"),i.classList.add(`uc-${t}`)})},getCurrentTheme(){return document.documentElement.classList.contains("dark")?"dark":"light"},setupThemeObservers(){window.addEventListener("storage",this.handleThemeStorageChange.bind(this)),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",this.handleSystemThemeChange.bind(this)),this.setupDocumentClassObserver()},handleThemeStorageChange(t){t.key==="theme"&&this.applyTheme()},handleSystemThemeChange(){localStorage.getItem("theme")==="system"&&this.applyTheme()},setupDocumentClassObserver(){this.documentClassObserver=new MutationObserver(t=>{t.forEach(e=>{if(e.type==="attributes"&&e.attributeName==="class"){let i=document.documentElement.classList.contains("dark"),a=e.oldValue&&e.oldValue.includes("dark");i!==a&&this.applyTheme()}})}),this.documentClassObserver.observe(document.documentElement,{attributes:!0,attributeOldValue:!0,attributeFilter:["class"]})},initUploadcare(){this.removeEventListeners&&this.removeEventListeners(),this.initializeUploader()},initializeUploader(t=0,e=10){if(t>=e)return;this.ctx=this.$el.querySelector(`uc-upload-ctx-provider[ctx-name="${this.uniqueContextName}"]`);let i=this.getUploadcareApi();if(!this.isValidContext(i)){setTimeout(()=>this.initializeUploader(t+1,e),100);return}this.markAsInitialized(),this.removeRequiredAttributes(),this.initializeState(i),this.setupEventListeners(i)},getUploadcareApi(){try{return this.ctx?.getAPI()}catch{return null}},isValidContext(t){return this.ctx&&t&&t.addFileFromCdnUrl},markAsInitialized(){this.isInitialized=!0},removeRequiredAttributes(){setTimeout(()=>{let t=this.$el.closest("uc-config");document.querySelectorAll("uc-form-input input[required]").forEach(i=>i.removeAttribute("required"))},100)},initializeState(t){this.initialState&&!this.stateHasBeenInitialized&&!this.uploadedFiles?this.loadInitialState(t):!this.initialState&&!this.stateHasBeenInitialized&&(this.stateHasBeenInitialized=!0,this.uploadedFiles=this.isMultiple||this.isWithMetadata?"[]":"",this.isLocalUpdate=!0,this.state=this.uploadedFiles)},loadInitialState(t){try{let e=this.parseInitialState();this.addFilesFromInitialState(t,e),this.stateHasBeenInitialized=!0,this.isLocalUpdate=!0,this.state=this.uploadedFiles}catch(e){console.error("Error parsing initialState:",e)}},parseInitialState(){let t=i=>{if(typeof i=="string")try{let a=JSON.parse(i);if(typeof a=="string")try{a=JSON.parse(a)}catch{}return a}catch{return i}return i};return this.initialState&&this.initialState&&typeof this.initialState=="object"&&!Array.isArray(this.initialState)&&(this.initialState=[this.initialState]),this.parseStateValue(this.initialState)},addFilesFromInitialState(t,e){let i=[];if(e&&e&&typeof e=="object"&&!Array.isArray(e))try{i=Array.from(e)}catch{i=[e]}else Array.isArray(e)?i=e:e&&(i=[e]);if(Array.isArray(i)&&i.length===1&&Array.isArray(i[0])&&(i=i[0]),Array.isArray(i)&&i.length===1&&typeof i[0]=="string")try{let r=JSON.parse(i[0]);i=Array.isArray(r)?r:[r]}catch{}if(!Array.isArray(i)||i.length===0)return;Array.isArray(i)||(i=[i]);let a=(r,o=0)=>{if(!r)return;if(Array.isArray(r)){r.forEach((h,d)=>{a(h,`${o}.${d}`)});return}if(typeof r=="string")try{let h=JSON.parse(r);a(h,o);return}catch{}let c=r&&typeof r=="object"?r.cdnUrl:r,p=r&&typeof r=="object"?r.cdnUrlModifiers:null;if(!c||!this.isValidUrl(c))return;let l=this.extractUuidFromUrl(c);if(l&&typeof t.addFileFromUuid=="function")try{if((p||c&&c.includes("/-/"))&&typeof t.addFileFromCdnUrl=="function"){let d=c;if(p){let y=c.split("/-/")[0],f=p;f.startsWith("/")&&(f=f.substring(1)),d=y+(y.endsWith("/")?"":"/")+(f.startsWith("-/")?"":"-/")+f}t.addFileFromCdnUrl(d)}else t.addFileFromUuid(l)}catch{}else console.error(l?"addFileFromUuid method not available on API":`Could not extract UUID from URL: ${c}`)};i.forEach(a);let s=i.map(r=>{let o=r;if(r&&typeof r=="object")return r.uuid||(r.uuid=this.extractUuidFromUrl(r.cdnUrl)),r;if(typeof r=="string"){let c=this.extractUuidFromUrl(r);return{cdnUrl:r,uuid:c,name:"",size:0,mimeType:"",isImage:!1}}return r}),n=this.formatFilesForState(s);this.uploadedFiles=JSON.stringify(n),this.initialState=this.uploadedFiles},isValidUrl(t){if(!t||typeof t!="string")return!1;try{return new URL(t),!0}catch{return!1}},setupStateWatcher(){this.$watch("state",t=>{if(this.isLocalUpdate){this.isLocalUpdate=!1;return}t==null||t===""||t==="[]"||Array.isArray(t)&&t.length===0?this.clearAllFiles(!1):t&&this.isInitialized&&this.addFilesFromState(t)})},parseStateValue(t){if(!t)return null;try{return typeof t=="string"?JSON.parse(t):t}catch{return t}},addFilesFromState(t){let i=this.parseStateValue(t);if(Array.isArray(i)||(i=[i]),i=i.filter(l=>l!=null),i.length===0)return!1;let a=this.getUploadcareApi();if(!a||typeof a.addFileFromCdnUrl!="function")return!1;let n=this.getCurrentFiles().map(l=>l?l&&typeof l=="object"?l.cdnUrl:l:null).filter(Boolean);i.forEach((l,h)=>{if(!l){console.warn(`[Uploadcare] Skipping null item at index ${h}`);return}let d=l&&typeof l=="object"?l.cdnUrl:l;if(d&&typeof d=="string"&&(d.includes("ucarecdn.com")||d.includes("ucarecd.net"))&&!n.some(f=>{let U=this.extractUuidFromUrl(d),F=this.extractUuidFromUrl(f);return U&&F&&U===F}))try{a.addFileFromCdnUrl(d)}catch(f){console.error("[Uploadcare] Failed to add file from URL:",d,f)}});let r=[],o=new Set,c=l=>{if(!l)return;let h=l&&typeof l=="object"?l.cdnUrl:l,d=this.extractUuidFromUrl(h);d&&!o.has(d)?(o.add(d),this.isWithMetadata&&typeof l!="object"?r.push({cdnUrl:l,uuid:d,name:"",size:0,mimeType:"",isImage:!1}):r.push(l)):d||r.push(l)},p=this.parseStateValue(t)||[];return(Array.isArray(p)?p:[p]).forEach(c),this.uploadedFiles=JSON.stringify(r),this.isLocalUpdate=!0,!0},normalizeStateValue(t){if(!t)return"";try{let e=typeof t=="string"?JSON.parse(t):t;if(Array.isArray(e)&&e.every(s=>typeof s=="string"||typeof s=="object"&&s!==null&&("cdnUrl"in s||"uuid"in s)))return JSON.stringify(e);let i=this.formatFilesForState(e);return JSON.stringify(i)}catch(e){return console.error("[Uploadcare] normalizeStateValue error",e),t}},isStateChanged(){let t=this.normalizeStateValue(this.state),e=this.normalizeStateValue(this.initialState);return t!==e},setupEventListeners(t){this.pendingUploads=[],this.pendingRemovals=[];let e=this.createFileUploadSuccessHandler(t),i=this.createFileUrlChangedHandler(t),a=this.createFileRemovedHandler(t),s=this.createFormInputChangeHandler(t),n=r=>{if(r.target!==this.ctx&&!this.ctx.contains(r.target))return;let o=this.$el.closest("form");o&&o.dispatchEvent(new CustomEvent("form-processing-started",{detail:{message:"Uploading file..."}}))};this.ctx.addEventListener("file-upload-started",n),this.ctx.addEventListener("file-upload-success",e),this.ctx.addEventListener("file-url-changed",i),this.ctx.addEventListener("file-removed",a),this.$nextTick(()=>{let r=this.$el.querySelector("uc-form-input input");if(r){r.addEventListener("input",s),r.addEventListener("change",s);let o=new MutationObserver(()=>{s({target:r})});o.observe(r,{attributes:!0,attributeFilter:["value"]}),this.formInputObserver=o}}),this.removeEventListeners=()=>{this.ctx.removeEventListener("file-upload-started",n),this.ctx.removeEventListener("file-upload-success",e),this.ctx.removeEventListener("file-url-changed",i),this.ctx.removeEventListener("file-removed",a);let r=this.$el.querySelector("uc-form-input input");r&&(r.removeEventListener("input",s),r.removeEventListener("change",s)),this.formInputObserver&&(this.formInputObserver.disconnect(),this.formInputObserver=null)}},createFileUploadSuccessHandler(t){let e=null;return i=>{if(i.target.getAttribute("ctx-name")!==this.uniqueContextName&&i.target!==this.ctx&&!this.ctx.contains(i.target))return;let s=this.isWithMetadata?i.detail:i.detail.cdnUrl;this.pendingUploads.push(s),e&&clearTimeout(e),e=setTimeout(()=>{try{let n=this.getCurrentFiles();for(let o of this.pendingUploads)n=this.updateFilesList(n,o);this.updateState(n),this.pendingUploads=[];let r=this.$el.closest("form");r&&r.dispatchEvent(new CustomEvent("form-processing-finished"))}catch(n){console.error("[Uploadcare] Error updating state after upload:",n)}},200)}},createFileUrlChangedHandler(t){let e=null;return i=>{if(i.target.getAttribute("ctx-name")!==this.uniqueContextName&&i.target!==this.ctx&&!this.ctx.contains(i.target))return;let a=i.detail;e&&clearTimeout(e),e=setTimeout(()=>{try{let s=this.getCurrentFiles(),n=this.updateFileUrl(s,a);this.updateState(n)}catch(s){console.error("Error updating state after URL change:",s)}},100)}},createFileRemovedHandler(t){let e=null;return i=>{if(i.target.getAttribute("ctx-name")!==this.uniqueContextName&&i.target!==this.ctx&&!this.ctx.contains(i.target))return;let a=i.detail;this.pendingRemovals.push(a),e&&clearTimeout(e),e=setTimeout(()=>{try{let s=this.getCurrentFiles();for(let n of this.pendingRemovals)s=this.removeFile(s,n);this.updateState(s),this.pendingRemovals=[]}catch(s){console.error("Error in handleFileRemoved:",s)}},100)}},createFormInputChangeHandler(t){return e=>{}},getCurrentFiles(){try{let t=this.uploadedFiles?JSON.parse(this.uploadedFiles):[];return Array.isArray(t)?t:[]}catch{return[]}},updateFilesList(t,e){if(this.isMultiple){let i=this.extractUuidFromUrl(e);return t.some(s=>this.extractUuidFromUrl(s)===i)?t:[...t,e]}return[e]},updateFileUrl(t,e){let i=e.uuid;if(!i&&e.cdnUrl&&(i=this.extractUuidFromUrl(e.cdnUrl)),!i)return t;e.uuid||(e={...e,uuid:i});let a=this.findFileIndex(t,i);if(a===-1)return t;let s;if(this.isWithMetadata){let n=t[a];if(typeof n=="string"){let r=this.extractUuidFromUrl(n);n={cdnUrl:n,uuid:r,name:"",size:0,mimeType:"",isImage:!1}}if(s={...n,...e},s.cdnUrl){let r=this.extractModifiersFromUrl(s.cdnUrl);r?s.cdnUrlModifiers=r:(s.cdnUrlModifiers=null,delete s.cdnUrlModifiers)}}else s=e.cdnUrl;if(this.isMultiple){let n=[...t];return n[a]=s,n}return[s]},removeFile(t,e){let i=this.findFileIndex(t,e.uuid);if(i===-1)return t;if(this.isMultiple){let a=[...t];return a.splice(i,1),a}return[]},findFileIndex(t,e){return e?t.findIndex(i=>{let a=i&&typeof i=="object"?i.cdnUrl:i;return this.extractUuidFromUrl(a)===e}):-1},updateState(t){if(!this.isUpdatingState){this.isUpdatingState=!0;try{let e=new Set,i=t.filter(c=>{let p=c&&typeof c=="object"?c.cdnUrl:c,l=this.extractUuidFromUrl(p);return l?e.has(l)?!1:(e.add(l),!0):!0}),a=this.formatFilesForState(i),s=this.buildStateFromFiles(a),n=this.normalizeStateValue(this.uploadedFiles),r=this.normalizeStateValue(s);n!==r&&(this.uploadedFiles=s,this.isLocalUpdate=!0,this.state=this.uploadedFiles,this.isMultiple&&i.length>1&&this.$nextTick(()=>{this.isLocalUpdate=!1}))}finally{this.isUpdatingState=!1}}},formatFilesForState(t){return t?Array.isArray(t)?t.map(e=>this.isWithMetadata?e:e&&typeof e=="object"?e.cdnUrl:e):[]:[]},setupDoneButtonObserver(){let t=this.$el.closest(".uploadcare-wrapper");t&&(this.doneButtonHider=new m(t))},destroy(){this.doneButtonHider&&(this.doneButtonHider.destroy(),this.doneButtonHider=null),this.documentClassObserver&&(this.documentClassObserver.disconnect(),this.documentClassObserver=null),this.formInputObserver&&(this.formInputObserver.disconnect(),this.formInputObserver=null),this.removeEventListeners&&this.removeEventListeners()},extractUuidFromUrl(t){if(!t)return null;let e=t;if(typeof t=="object"){if(t.uuid)return t.uuid;e=t.cdnUrl||""}if(!e||typeof e!="string")return null;if(/^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$/i.test(e))return e;let a=e.match(/\/([a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12})(?:\/|$)/i);return a?a[1]:null},extractModifiersFromUrl(t){if(!t||typeof t!="string")return"";let e=this.extractUuidFromUrl(t);if(!e)return"";let i=t.split(e);if(i.length<2)return"";let a=i[1];return a.startsWith("/")&&(a=a.substring(1)),a.endsWith("/")&&(a=a.substring(0,a.length-1)),a},async syncStateWithUploadcare(t){try{let e=this.getCurrentFilesFromUploadcare(t);if(e.length>0){let s=[];for(let n of e){let r=n&&typeof n=="object"?n.cdnUrl:n;if(typeof r=="string"&&r.match(/[a-f0-9-]{36}~[0-9]+/))try{let o=await this.fetchGroupFiles(r);s.push(...o)}catch{s.push(n)}else s.push(n)}e=s}let i=this.formatFilesForState(e),a=this.buildStateFromFiles(i);this.normalizeStateValue(this.uploadedFiles)!==this.normalizeStateValue(a)&&(this.uploadedFiles=a,this.isLocalUpdate=!0,this.state=this.uploadedFiles)}catch(e){console.error("Error syncing state with Uploadcare:",e)}},async fetchGroupFiles(t){let e=t;if(t.includes("ucarecdn.com")||t.includes("ucarecd.net")){let s=t.match(/\/([a-f0-9-]{36}~[0-9]+)/);s&&(e=s[1])}let i=await fetch(`https://upload.uploadcare.com/group/info/?pub_key=${this.publicKey}&group_id=${e}`);if(!i.ok)throw new Error(`Failed to fetch group info: ${i.statusText}`);let a=await i.json();return a.files?a.files.map(s=>{let n=`https://ucarecdn.com/${s.uuid}/`;return this.isWithMetadata?{uuid:s.uuid,cdnUrl:n,name:s.original_filename,size:s.size,mimeType:s.mime_type,isImage:s.is_image}:n}):[]},buildStateFromFiles(t){return this.isMultiple||this.isWithMetadata?JSON.stringify(t):t.length>0?t[0]:""},getCurrentFilesFromUploadcare(t){try{if(t&&typeof t.value=="function"){let i=t.value();if(i)return(Array.isArray(i)?i:this.parseFormInputValue(i)).filter(s=>s!=null)}let e=this.$el.querySelector("uc-form-input input");return e?this.parseFormInputValue(e.value).filter(i=>i!=null):[]}catch(e){return console.error("Error getting current files from Uploadcare:",e),[]}},parseFormInputValue(t){if(!t||typeof t=="string"&&t.trim()==="")return[];if(typeof t=="object")return[t];try{let e=JSON.parse(t);return Array.isArray(e)?e.filter(i=>i!==null&&i!==""):e!==null&&e!==""?[e]:[]}catch{return typeof t=="string"&&t.trim()!==""?[t]:[]}},clearAllFiles(t=!0){let e=this.getUploadcareApi();if(e){try{if(e.collection&&typeof e.collection.clear=="function")e.collection.clear();else if(typeof e.getCollection=="function"){let i=e.getCollection();i&&typeof i.clear=="function"&&i.clear()}}catch{}try{typeof e.removeAllFiles=="function"&&e.removeAllFiles()}catch{}try{typeof e.value=="function"&&e.value(this.isMultiple?[]:"")}catch{}}this.uploadedFiles!==(this.isMultiple||this.isWithMetadata?"[]":"")&&(this.uploadedFiles=this.isMultiple||this.isWithMetadata?"[]":"",this.isLocalUpdate=!0,t&&(this.state=this.uploadedFiles))}}}export{g as default};
