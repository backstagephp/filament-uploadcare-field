var p=class{constructor(e){this.wrapper=e,this.observer=null,this.init()}init(){this.hideDoneButtons(),this.setupObserver()}setupObserver(){this.observer=new MutationObserver(e=>{e.forEach(t=>{t.type==="childList"&&t.addedNodes.forEach(i=>{if(i.nodeType===Node.ELEMENT_NODE){i.classList&&i.classList.contains("uc-done-btn")&&this.hideDoneButton(i);let r=i.querySelectorAll&&i.querySelectorAll(".uc-done-btn");r&&r.forEach(l=>this.hideDoneButton(l))}})})}),this.wrapper&&this.observer.observe(this.wrapper,{childList:!0,subtree:!0})}hideDoneButtons(){document.querySelectorAll(".uc-done-btn").forEach(t=>this.hideDoneButton(t))}hideDoneButton(e){e&&(e.style.display="none",e.style.visibility="hidden",e.style.opacity="0",e.style.pointerEvents="none",e.style.position="absolute",e.style.width="0",e.style.height="0",e.style.overflow="hidden",e.style.clip="rect(0, 0, 0, 0)",e.style.margin="0",e.style.padding="0",e.style.border="0",e.style.background="transparent",e.style.color="transparent",e.style.fontSize="0",e.style.lineHeight="0")}destroy(){this.observer&&(this.observer.disconnect(),this.observer=null)}};function f(o){return window._initializedUploadcareContexts||(window._initializedUploadcareContexts=new Set),{state:o.state,statePath:o.statePath,initialState:o.initialState,publicKey:o.publicKey,isMultiple:o.isMultiple,multipleMin:o.multipleMin,multipleMax:o.multipleMax,isImagesOnly:o.isImagesOnly,accept:o.accept,sourceList:o.sourceList,uploaderStyle:o.uploaderStyle,isWithMetadata:o.isWithMetadata,localeName:o.localeName||"en",uploadedFiles:"",ctx:null,removeEventListeners:null,uniqueContextName:o.uniqueContextName,isInitialized:!1,stateHasBeenInitialized:!1,isStateWatcherActive:!1,isLocalUpdate:!1,doneButtonHider:null,documentClassObserver:null,formInputObserver:null,async init(){this.isContextAlreadyInitialized()||(this.markContextAsInitialized(),this.applyTheme(),await this.loadAllLocales(),this.setupStateWatcher(),this.$el.addEventListener("uploadcare-state-updated",e=>{let t=e.detail.uuid;t&&this.isInitialized?this.loadFileFromUuid(t):t&&this.$nextTick(()=>{this.isInitialized&&this.loadFileFromUuid(t)})}),this.initUploadcare(),this.setupThemeObservers(),this.setupDoneButtonObserver())},isContextAlreadyInitialized(){return window._initializedUploadcareContexts.has(this.uniqueContextName)},markContextAsInitialized(){window._initializedUploadcareContexts.add(this.uniqueContextName)},async loadAllLocales(){window._uploadcareAllLocalesLoaded||await new Promise(t=>{if(window._uploadcareAllLocalesLoaded){t();return}let i=setInterval(()=>{window._uploadcareAllLocalesLoaded&&(clearInterval(i),t())},100);setTimeout(()=>{clearInterval(i),t()},5e3)});let e=["de","es","fr","he","it","nl","pl","pt","ru","tr","uk","zh-TW","zh"];document.querySelectorAll("uc-config[data-locale-name]").forEach(t=>{let i=t.getAttribute("data-locale-name");i&&e.includes(i)&&!t.getAttribute("locale-name")&&t.setAttribute("locale-name",i)})},async loadLocale(){if(this.localeName==="en"||this.localeLoaded)return;if(window._uploadcareLocales&&window._uploadcareLocales.has(this.localeName)){this.localeLoaded=!0;return}if(window._uploadcareLocales||(window._uploadcareLocales=new Set),!!["de","es","fr","he","it","nl","pl","pt","ru","tr","uk","zh-TW","zh"].includes(this.localeName))try{let i=await import(`https://cdn.jsdelivr.net/npm/@uploadcare/file-uploader@v1/locales/file-uploader/${this.localeName}.js`),r=i.default||i,l=()=>{let a=customElements.get("uc-file-uploader-inline")||customElements.get("uc-file-uploader-regular")||customElements.get("uc-file-uploader-minimal");return a&&a.UC?a.UC:window.UC},s=()=>{let a=l();return a&&typeof a.defineLocale=="function"?(a.defineLocale(this.localeName,r),window._uploadcareLocales.add(this.localeName),this.localeLoaded=!0,!0):!1};if(!s()){let a=0,n=50,u=setInterval(()=>{a++,(s()||a>=n)&&clearInterval(u)},100)}}catch(t){console.error("[Uploadcare Locale JS] Failed to load locale:",this.localeName,t)}},applyTheme(){let e=this.getCurrentTheme();document.querySelectorAll(`uc-file-uploader-${this.uploaderStyle}`).forEach(i=>{i.classList.remove("uc-dark","uc-light"),i.classList.add(`uc-${e}`)})},getCurrentTheme(){return document.documentElement.classList.contains("dark")?"dark":"light"},setupThemeObservers(){window.addEventListener("storage",this.handleThemeStorageChange.bind(this)),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",this.handleSystemThemeChange.bind(this)),this.setupDocumentClassObserver()},handleThemeStorageChange(e){e.key==="theme"&&this.applyTheme()},handleSystemThemeChange(){localStorage.getItem("theme")==="system"&&this.applyTheme()},setupDocumentClassObserver(){this.documentClassObserver=new MutationObserver(e=>{e.forEach(t=>{if(t.type==="attributes"&&t.attributeName==="class"){let i=document.documentElement.classList.contains("dark"),r=t.oldValue&&t.oldValue.includes("dark");i!==r&&this.applyTheme()}})}),this.documentClassObserver.observe(document.documentElement,{attributes:!0,attributeOldValue:!0,attributeFilter:["class"]})},initUploadcare(){this.removeEventListeners&&this.removeEventListeners(),this.initializeUploader()},initializeUploader(e=0,t=10){if(e>=t)return;this.ctx=document.querySelector(`uc-upload-ctx-provider[ctx-name="${this.uniqueContextName}"]`);let i=this.getUploadcareApi();if(!this.isValidContext(i)){setTimeout(()=>this.initializeUploader(e+1,t),100);return}this.markAsInitialized(),this.removeRequiredAttributes(),this.initializeState(i),this.setupEventListeners(i)},getUploadcareApi(){try{return this.ctx?.getAPI()}catch{return null}},isValidContext(e){return this.ctx&&e&&e.addFileFromCdnUrl},markAsInitialized(){this.isInitialized=!0},removeRequiredAttributes(){setTimeout(()=>{let e=this.$el.closest("uc-config");document.querySelectorAll("uc-form-input input[required]").forEach(i=>i.removeAttribute("required"))},100)},initializeState(e){this.$nextTick(()=>{this.initialState&&!this.stateHasBeenInitialized&&!this.uploadedFiles?this.loadInitialState(e):!this.initialState&&!this.stateHasBeenInitialized&&(this.stateHasBeenInitialized=!0,this.uploadedFiles=this.isMultiple?"[]":"",this.isLocalUpdate=!0,this.state=this.uploadedFiles)})},loadInitialState(e){try{let t=this.parseInitialState();this.addFilesFromInitialState(e,t),this.stateHasBeenInitialized=!0,this.isLocalUpdate=!0,this.state=this.uploadedFiles}catch(t){console.error("Error parsing initialState:",t)}},parseInitialState(){let e=t=>{if(typeof t=="string")try{let i=JSON.parse(t);if(typeof i=="string")try{i=JSON.parse(i)}catch{}return i}catch{return t}return t};if(this.initialState&&typeof this.initialState=="object"&&!Array.isArray(this.initialState)){let t=Object.keys(this.initialState);if(t.length===1)return e(this.initialState[t[0]])}return e(this.initialState)},addFilesFromInitialState(e,t){let i=t;if(t&&typeof t=="object"&&!Array.isArray(t))try{i=Array.from(t)}catch{i=[t]}else Array.isArray(t)||(i=[t]);if(Array.isArray(i)&&i.length===1&&Array.isArray(i[0])&&(i=i[0]),Array.isArray(i)&&i.length===1&&typeof i[0]=="string")try{let s=JSON.parse(i[0]);i=Array.isArray(s)?s:[s]}catch{}Array.isArray(i)||(i=[i]);let r=(s,a=0)=>{if(!s)return;if(Array.isArray(s)){s.forEach((d,h)=>{r(d,`${a}.${h}`)});return}if(typeof s=="string")try{let d=JSON.parse(s);r(d,a);return}catch{}let n=typeof s=="object"?s.cdnUrl:s,u=typeof s=="object"?s.cdnUrlModifiers:null;if(!n||!this.isValidUrl(n))return;let c=this.extractUuidFromUrl(n);if(c&&typeof e.addFileFromUuid=="function")try{if(u&&typeof e.addFileFromCdnUrl=="function"){let h=n.split("/-/")[0]+"/"+u;e.addFileFromCdnUrl(h)}else e.addFileFromUuid(c)}catch(d){console.error(`Failed to add file ${a} with UUID ${c}:`,d)}else console.error(c?"addFileFromUuid method not available on API":`Could not extract UUID from URL: ${n}`)};i.forEach(r);let l=this.formatFilesForState(i);this.uploadedFiles=JSON.stringify(l),this.initialState=this.uploadedFiles},isValidUrl(e){if(!e||typeof e!="string")return!1;try{return new URL(e),!0}catch{return!1}},setupStateWatcher(){this.$watch("state",(e,t)=>{if(this.isLocalUpdate){this.isLocalUpdate=!1;return}if(!this.stateHasBeenInitialized){this.stateHasBeenInitialized=!0;return}if((!e||e==="[]"||e==='""')&&!this.uploadedFiles)return;let i=this.normalizeStateValue(e),r=this.normalizeStateValue(this.uploadedFiles);i!==r&&e&&e!=="[]"&&e!=='""'&&this.addFilesFromState(e)})},parseStateValue(e){if(!e)return null;try{return typeof e=="string"?JSON.parse(e):e}catch{return e}},addFilesFromState(e){let i=this.parseStateValue(e);if(Array.isArray(i)||(i=[i]),i.length===0)return!1;let r=this.getUploadcareApi();if(!r||typeof r.addFileFromCdnUrl!="function")return!1;let s=this.getCurrentFiles().map(a=>typeof a=="object"?a.cdnUrl:a).filter(Boolean);return i.forEach(a=>{let n=typeof a=="object"?a.cdnUrl:a;if(n&&typeof n=="string"&&n.includes("ucarecdn.com")&&!s.some(c=>{let d=this.extractUuidFromUrl(n),h=this.extractUuidFromUrl(c);return d&&h&&d===h}))try{r.addFileFromCdnUrl(n)}catch(c){console.error("[Uploadcare] Failed to add file from URL:",n,c)}}),this.uploadedFiles=e,this.isLocalUpdate=!0,!0},normalizeStateValue(e){if(!e)return"";try{let t=typeof e=="string"?JSON.parse(e):e;return JSON.stringify(this.formatFilesForState(t))}catch{return e}},isStateChanged(){let e=this.normalizeStateValue(this.state),t=this.normalizeStateValue(this.initialState);return e!==t},setupEventListeners(e){let t=this.createFileUploadSuccessHandler(),i=this.createFileUrlChangedHandler(),r=this.createFileRemovedHandler(),l=this.createFormInputChangeHandler(e);this.ctx.addEventListener("file-upload-started",s=>{let a=this.$el.closest("form");a&&a.dispatchEvent(new CustomEvent("form-processing-started",{detail:{message:"Uploading file..."}}))}),this.ctx.addEventListener("file-upload-success",t),this.ctx.addEventListener("file-url-changed",i),this.ctx.addEventListener("file-removed",r),this.$nextTick(()=>{let s=this.$el.querySelector("uc-form-input input");if(s){s.addEventListener("input",l),s.addEventListener("change",l);let a=new MutationObserver(()=>{l({target:s})});a.observe(s,{attributes:!0,attributeFilter:["value"]}),this.formInputObserver=a}else setTimeout(()=>{let a=this.$el.querySelector("uc-form-input input");a&&(a.addEventListener("input",l),a.addEventListener("change",l))},200)}),this.removeEventListeners=()=>{this.ctx.removeEventListener("file-upload-started",a=>{let n=this.$el.closest("form");n&&n.dispatchEvent(new CustomEvent("form-processing-started",{detail:{message:"Uploading file..."}}))}),this.ctx.removeEventListener("file-upload-success",t),this.ctx.removeEventListener("file-url-changed",i),this.ctx.removeEventListener("file-removed",r);let s=this.$el.querySelector("uc-form-input input");s&&(s.removeEventListener("input",l),s.removeEventListener("change",l)),this.formInputObserver&&(this.formInputObserver.disconnect(),this.formInputObserver=null)}},createFileUploadSuccessHandler(){let e=null;return t=>{e&&clearTimeout(e),e=setTimeout(()=>{let i=this.isWithMetadata?t.detail:t.detail.cdnUrl;try{let r=this.getCurrentFiles(),l=this.updateFilesList(r,i);this.updateState(l);let s=this.$el.closest("form");s&&s.dispatchEvent(new CustomEvent("form-processing-finished"))}catch(r){console.error("[Uploadcare] Error updating state after upload:",r)}},this.isMultiple?200:100)}},createFileUrlChangedHandler(){let e=null;return t=>{let i=t.detail;!i||!i.cdnUrl||(e&&clearTimeout(e),e=setTimeout(()=>{try{let r=this.getCurrentFiles(),l=this.updateFileUrl(r,i);this.updateState(l)}catch(r){console.error("Error updating state after URL change:",r)}},100))}},createFileRemovedHandler(){let e=null;return t=>{e&&clearTimeout(e),e=setTimeout(()=>{try{let i=t.detail,r=this.getCurrentFiles(),l=this.removeFile(r,i);this.updateState(l);let s=this.getUploadcareApi();s&&setTimeout(()=>{this.syncStateWithUploadcare(s)},150)}catch(i){console.error("Error in handleFileRemoved:",i)}},100)}},createFormInputChangeHandler(e){let t=null;return i=>{t&&clearTimeout(t),t=setTimeout(()=>{this.syncStateWithUploadcare(e)},200)}},getCurrentFiles(){try{let e=this.uploadedFiles?JSON.parse(this.uploadedFiles):[];return Array.isArray(e)?e:[]}catch{return[]}},updateFilesList(e,t){return this.isMultiple?e.some(r=>{let l=typeof r=="object"?r.cdnUrl:r,s=typeof t=="object"?t.cdnUrl:t;return l===s})?e:[...e,t]:[t]},updateFileUrl(e,t){let i=t.uuid;if(!i&&t.cdnUrl&&(i=this.extractUuidFromUrl(t.cdnUrl)),!i)return e;t.uuid||(t={...t,uuid:i});let r=this.findFileIndex(e,i);if(r===-1)return e;let l;return this.isWithMetadata?l={...e[r],...t}:l=t.cdnUrl,this.isMultiple?(e[r]=l,e):[l]},removeFile(e,t){let i=this.findFileIndex(e,t.uuid);return i===-1?e:this.isMultiple?(e.splice(i,1),e):[]},findFileIndex(e,t){return e.findIndex(i=>{let r=typeof i=="object"?i.cdnUrl:i;return r&&r.includes(t)})},updateState(e){let t=this.formatFilesForState(e),i=JSON.stringify(t),r=this.getCurrentFiles(),l=JSON.stringify(this.formatFilesForState(r)),s=JSON.stringify(this.formatFilesForState(t));l!==s&&(this.uploadedFiles=i,this.isLocalUpdate=!0,this.state=this.uploadedFiles,this.isMultiple&&e.length>1&&this.$nextTick(()=>{this.isLocalUpdate=!1}))},formatFilesForState(e){return e.map(t=>this.isWithMetadata?t:typeof t=="object"?t.cdnUrl:t)},setupDoneButtonObserver(){let e=this.$el.closest(".uploadcare-wrapper");e&&(this.doneButtonHider=new p(e))},destroy(){this.doneButtonHider&&(this.doneButtonHider.destroy(),this.doneButtonHider=null),this.documentClassObserver&&(this.documentClassObserver.disconnect(),this.documentClassObserver=null),this.formInputObserver&&(this.formInputObserver.disconnect(),this.formInputObserver=null),this.removeEventListeners&&this.removeEventListeners()},extractUuidFromUrl(e){if(!e||typeof e!="string")return null;let t=e.match(/\/([a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12})(?:\/|$)/i);return t&&t[1]?t[1]:typeof e=="object"&&e.uuid?e.uuid:null},syncStateWithUploadcare(e){try{let t=this.getCurrentFilesFromUploadcare(e),i=this.formatFilesForState(t),r=this.buildStateFromFiles(i),l=this.normalizeStateValue(this.uploadedFiles),s=this.normalizeStateValue(r);l!==s&&(this.uploadedFiles=r,this.isLocalUpdate=!0,this.state=this.uploadedFiles)}catch(t){console.error("Error syncing state with Uploadcare:",t)}},buildStateFromFiles(e){return this.isMultiple?JSON.stringify(e):e.length>0?this.isWithMetadata?JSON.stringify(e[0]):e[0]:""},getCurrentFilesFromUploadcare(e){try{let t=this.$el.querySelector("uc-form-input input");return t?this.parseFormInputValue(t.value):this.$el.querySelectorAll("uc-file-item, [data-file-item]").length===0?[]:[]}catch(t){return console.error("Error getting current files from Uploadcare:",t),[]}},parseFormInputValue(e){if(!e||typeof e=="string"&&e.trim()==="")return[];try{let t=JSON.parse(e);return Array.isArray(t)?t.filter(i=>i!==null&&i!==""):t!==null&&t!==""?[t]:[]}catch{return typeof e=="string"&&e.trim()!==""?[e]:[]}}}}export{f as default};
